<?xml version="1.0" encoding="UTF-8"?>
<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== #29. 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="eunji">

	<select id="selectMemberInfo" parameterType="HashMap" resultType="com.project.skyuniversity.eunji.model.MemberVO">
		select currentSemester, name, memberNo, deptName
		from tbl_member M
		inner join tbl_dept D
		on M.fk_deptseq = D.deptseq
		where memberno = #{memberNo}
	</select>
	
	<select id="selectAllDept" resultType="String" >
		select deptname
		from tbl_dept
	</select>
	
	<select id="selectAllSubject" resultType="String" >
		select subjectname
		from tbl_subject
	</select>
	
	<select id="selectDeptClass" resultType="String" parameterType="HashMap">
		select subjectname
		from tbl_subject S
		inner join tbl_dept D
		on S.fk_deptseq = D.deptseq
		where 1=1
		<if test="dept != null">
			and deptname = #{dept}
		</if>
		<if test="grade != null">
			and grade = #{grade}
		</if>
	</select>
	
	<resultMap type="HashMap" id="subjectsMap">
		<result property="deptname" column="deptname" javaType="String"/>
		<result property="subjectname" column="subjectname" javaType="String"/>
		<result property="subjectno" column="subjectno" javaType="String"/>
		<result property="name" column="name" javaType="String"/>
		<result property="credits" column="credits" javaType="String"/>
		<result property="day" column="day" javaType="String"/>
		<result property="period" column="period" javaType="String"/>
		<result property="peoplecnt" column="peoplecnt" javaType="String"/>
		<result property="grade" column="grade" javaType="String"/>
		<result property="curpeoplecnt" column="curpeoplecnt" javaType="String"/>
	</resultMap>
	<select id="getSubjectList" resultMap="subjectsMap">
		select deptname, subjectname, subjectno, name, credits, day, period, peoplecnt, grade, curpeoplecnt
		from
		(
		select p.name, subjectno, subjectname, credits, day, period, peoplecnt, fk_deptseq, grade, curpeoplecnt
		from tbl_subject S
		inner join tbl_professor P
		on S.fk_professorno = p.professorno
		) V
		inner join tbl_dept D
		on V.fk_deptseq = D.deptseq
		where 1=1 
		<if test="dept != null">
			and deptname = #{dept}
		</if>
		<if test="grade != null">
			and grade = #{grade}
		</if>
		<if test="firstsub != null">
			and subjectname = #{firstsub}
		</if>
		<if test="subject != null">
			and subjectname = #{subject}
		</if>
	</select>
	
	<select id="selectDeptOneSub" parameterType="String" resultType="String">
		select deptname
		from tbl_dept D
		inner join tbl_subject S
		on D.deptseq = S.fk_deptseq
		where subjectno = #{subjectno}
	</select>
	
	<insert id="insertCourse" parameterType="HashMap">
		insert into tbl_course(courseno,semester,courseyear, fk_memberno, fk_subjectNo)
		values(tbl_course_seq.nextval, #{currentsemester}, #{year}, #{memberNo}, #{subjectno})
	</insert>
	
	<select id="recourseInfo" parameterType="HashMap" resultType="int">
		select count(fk_subjectno)
		from tbl_course
		where fk_memberno = #{memberNo} and fk_subjectno=#{subjectno} and recourse ='1'
	</select>
	
	<insert id="insertReCourse" parameterType="HashMap">
		insert into tbl_course(courseno,semester,courseyear, fk_memberno, fk_subjectNo)
		values(tbl_course_seq.nextval, #{cursemester}, #{year}, #{memberno}, #{subjectno})
	</insert>
	
	<select id="recourseInfo2" parameterType="HashMap" resultType="int">
		select count(fk_subjectno)
		from tbl_course
		where fk_memberno = #{memberNo} and fk_subjectno=#{subjectno} and recourse ='0'
	</select>
	
	<update id="updatePlusCnt" parameterType="String">
		update Tbl_Subject set Curpeoplecnt = Curpeoplecnt+1 where Subjectno = #{string}
	</update>
	
	<resultMap type="HashMap" id="regMap">
		<result property="subjectname" column="subjectname" javaType="String"/>
		<result property="subjectno" column="subjectno" javaType="String"/>
		<result property="name" column="name" javaType="String"/>
		<result property="credits" column="credits" javaType="String"/>
		<result property="day" column="day" javaType="String"/>
		<result property="period" column="period" javaType="String"/>
		<result property="peoplecnt" column="peoplecnt" javaType="String"/>
		<result property="curpeoplecnt" column="curpeoplecnt" javaType="String"/>
		<result property="courseno" column="courseno" javaType="String"/>
	</resultMap>
	<select id="selectRegList" parameterType="HashMap" resultMap="regMap">
		select name, subjectname, credits, subjectno, day, period, peoplecnt, curpeoplecnt, courseno
		from
		(
		select name, subjectno, subjectname, credits, day, period, peoplecnt, curpeoplecnt
		from tbl_subject S
		inner join tbl_professor P
		on S.fk_professorno = P.professorno
		) V
		inner join tbl_course C
		on V.subjectno = C.fk_subjectno
		where fk_memberno = #{memberno} and courseyear = #{year} and semester = #{cursemester}
	</select>
	
	<delete id="deleteCourse" parameterType="String">
		delete from tbl_course where courseno=#{no}
	</delete>
	
	<update id="updateDelCnt" parameterType="String">
		update Tbl_Subject set Curpeoplecnt = Curpeoplecnt-1 where Subjectno = #{subno}
	</update>
	
	<select id="selectSumCredit" parameterType="HashMap" resultType="int">
		select sum(credits)
		from tbl_course C
		inner join tbl_subject S
		on c.fk_subjectno = S.subjectno
		where fk_memberno = #{memberno} and courseyear = #{year} and semester = #{cursemester}
	</select>
	
	<select id="dayInfo" parameterType="HashMap" resultType="int">
		select count(*)
		from tbl_course C
		inner join tbl_subject S
		on c.fk_subjectno = S.subjectno
		where fk_memberno = #{memberNo} and day = #{day} and period = #{period}
	</select>
	
	<select id="uniqueInfo" parameterType="HashMap" resultType="int">
		select count(*)
		from tbl_course C
		inner join tbl_subject S
		on c.fk_subjectno = S.subjectno
		where fk_memberno = #{memberNo} and subjectno = #{subjectno} and recourse = '0'
	</select>
	
	<insert id="add" parameterType="com.project.skyuniversity.eunji.model.OfficialLeaveVO">
		insert into tbl_official_leave(leaveno, startdate, enddate, starttime, endtime, reason, fk_memberno)
		values(tbl_official_leave_seq.nextval, #{startDate}, #{endDate}, #{startTime}, #{endTime}, #{reason}, #{fk_memberNo})
	</insert>
	
	<insert id="addNonTime" parameterType="com.project.skyuniversity.eunji.model.OfficialLeaveVO">
		insert into tbl_official_leave(leaveno, startdate, enddate, reason, fk_memberno)
		values(tbl_official_leave_seq.nextval, #{startDate}, #{endDate}, #{reason}, #{fk_memberNo})
	</insert>
	
	<insert id="add_withFile" parameterType="com.project.skyuniversity.eunji.model.OfficialLeaveVO">
		insert into tbl_official_leave(leaveno, startdate, enddate, starttime, endtime, reason, fk_memberno, filename, orgfilename, filesize)
		values(tbl_official_leave_seq.nextval, #{startDate}, #{endDate}, #{startTime}, #{endTime}, #{reason}, #{fk_memberNo}, #{fileName}, #{orgFileName}, #{fileSize})
	</insert>
	
	<insert id="add_withFileNonTime" parameterType="com.project.skyuniversity.eunji.model.OfficialLeaveVO">
		insert into tbl_official_leave(leaveno, startdate, enddate, reason, fk_memberno, filename, orgfilename, filesize)
		values(tbl_official_leave_seq.nextval, #{startDate}, #{endDate}, #{reason}, #{fk_memberNo}, #{fileName}, #{orgFileName}, #{fileSize})
	</insert>
	
	<select id="selectOfficial" resultType="com.project.skyuniversity.eunji.model.OfficialLeaveVO" parameterType="String">
		select leaveNo, to_char(startDate, 'yyyy-mm-dd') as startDate, to_char(endDate, 'yyyy-mm-dd') as endDate, reason, approve, approveDate, noReason, to_char(regdate, 'yyyy-mm-dd') as regdate
		from tbl_official_leave
		<![CDATA[where add_months(sysdate, -3) <= regdate]]> and fk_memberno = #{string}
		order by  regdate desc
	</select>
	
	<delete id="delOfficialLeave" parameterType="String">
		delete from tbl_official_leave where leaveno=#{seq}
	</delete>
	
	<resultMap type="HashMap" id="leaveMap">
		<result property="name" column="name" javaType="String"/>
		<result property="memberno" column="memberno" javaType="String"/>
		<result property="grade" column="grade" javaType="String"/>
		<result property="deptname" column="deptname" javaType="String"/>
		<result property="filename" column="filename" javaType="String"/>
		<result property="orgfilename" column="orgfilename" javaType="String"/>
		<result property="filesize" column="filesize" javaType="String"/>
		<result property="leaveNo" column="leaveNo" javaType="String"/>
		<result property="startDate" column="startDate" javaType="String"/>
		<result property="endDate" column="endDate" javaType="String"/>
		<result property="reason" column="reason" javaType="String"/>
		<result property="approve" column="approve" javaType="String"/>
		<result property="approveDate" column="approveDate" javaType="String"/>
		<result property="noReason" column="noReason" javaType="String"/>
	</resultMap>
	<select id="selectLeaveInfo" parameterType="HashMap" resultMap="leaveMap">
		select name, memberno, grade, deptname, filename, orgfilename, filesize, leaveNo, startDate, endDate, reason, approve, approveDate, noReason
		from
		(
		select rownum as rno, name, memberno, grade, deptname, filename, orgfilename, filesize, leaveNo, startDate, endDate, reason, approve, approveDate, noReason, regdate, regyear, regmonth
		from
		(
		    select name, memberno, grade, deptname, filename, orgfilename, filesize, leaveNo, to_char(startDate, 'yyyy-mm-dd') as startDate, to_char(regdate, 'yyyy') as regyear,to_char(regdate, 'mm') as regmonth, to_char(endDate, 'yyyy-mm-dd') as endDate, reason, approve, approveDate, noReason, to_char(regdate, 'yyyy-mm-dd') as regdate
		    from 
		    (
		    select name, memberno, grade, deptname
		    from tbl_member M
		    inner join tbl_dept D
		    on M.fk_deptseq = D.deptseq
		    )V
		    inner join tbl_official_leave O
		    on V.memberno = O.fk_memberno
		    where fk_memberno = #{memberno}
		    order by regdate desc
		)
		where approve in ('승인완료','승인취소') and regyear = #{year} and regmonth in (${month})
		)
		where rno between 1 and 3

	</select>
	
	<select id="getLeaveVO" parameterType="String" resultType="com.project.skyuniversity.eunji.model.OfficialLeaveVO">
		select startDate, endDate, reason, approve, noReason, approveDate, fileName, orgFileName, fileSize, regdate, fk_memberNo
        from tbl_official_leave
        where leaveNo=#{seq}
	</select>
</mapper>